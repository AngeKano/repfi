generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id             String          @id @default(cuid())
  name           String
  denomination   String?
  description    String?
  companyType    CompanyType
  email          String          @unique
  phone          String?
  website        String?
  packType       PackType        @default(SIMPLE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  clients        Client[]
  socialNetworks SocialNetwork[]
  members        User[]

  @@index([email])
  @@index([packType])
  @@map("companies")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  password          String
  firstName         String?
  lastName          String?
  isActive          Boolean            @default(true)
  companyId         String
  role              UserRole           @default(USER)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLoginAt       DateTime?
  clientAssignments ClientAssignment[]
  createdClients    Client[]           @relation("ClientCreator")
  modifiedClients   Client[]           @relation("ClientModifier")
  uploadedFiles     File[]
  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([companyId])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Client {
  id             String             @id @default(cuid())
  name           String
  denomination   String?
  description    String?
  companyType    CompanyType
  email          String
  phone          String?
  website        String?
  companyId      String
  isSelfEntity   Boolean            @default(false)
  createdById    String
  modifiedById   String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  assignments    ClientAssignment[]
  company        Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy      User               @relation("ClientCreator", fields: [createdById], references: [id])
  modifiedBy     User?              @relation("ClientModifier", fields: [modifiedById], references: [id])
  files          File[]
  socialNetworks SocialNetwork[]
  comptablePeriods ComptablePeriod[] // Added to provide the opposite relation for ComptablePeriod.client

  @@index([companyId])
  @@index([isSelfEntity])
  @@index([createdById])
  @@map("clients")
}

model ClientAssignment {
  id         String   @id @default(cuid())
  userId     String
  clientId   String
  role       UserRole @default(USER)
  assignedAt DateTime @default(now())
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@index([userId])
  @@index([clientId])
  @@index([role])
  @@map("client_assignments")
}

model SocialNetwork {
  id        String            @id @default(cuid())
  type      SocialNetworkType
  url       String
  companyId String?
  clientId  String?
  createdAt DateTime          @default(now())
  client    Client?           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  company   Company?          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([clientId])
  @@map("social_networks")
}

// Ajout dans schema.prisma

model File {
  id           String     @id @default(cuid())
  fileName     String
  fileType     FileType
  fileYear     Int
  s3Key        String     @unique
  s3Url        String
  fileSize     Int
  mimeType     String
  checksum     String?
  status       FileStatus @default(EN_COURS)
  errorMessage String?
  clientId     String
  uploadedById String
  uploadedAt   DateTime   @default(now())
  processedAt  DateTime?
  deletedAt    DateTime?
  deletedById  String?
  client       Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  uploadedBy   User       @relation(fields: [uploadedById], references: [id])

  // NOUVEAU : Catégorisation des fichiers
  category      FileCategory  @default(NORMAL)

  // Pour fichiers comptables uniquement
  periodStart   DateTime?
  periodEnd     DateTime?
  processingStatus ProcessingStatus @default(PENDING)
  batchId       String?       // Pour regrouper les 5 fichiers d'une période

  // Lien vers une période comptable (relation 0/1-n)
  comptablePeriodId String?
  comptablePeriod   ComptablePeriod? @relation(fields: [comptablePeriodId], references: [id], onDelete: SetNull, name: "PeriodFiles")

  @@index([clientId])
  @@index([uploadedById])
  @@index([fileType])
  @@index([fileYear])
  @@index([status])
  @@index([deletedAt])
  @@index([category])
  @@index([batchId])
  @@index([processingStatus])
  @@map("files")
}

model FileHistory {
  id         String   @id @default(cuid())
  fileId     String
  fileName   String
  action     String
  details    String?
  userId     String
  userEmail  String
  occurredAt DateTime @default(now())

  @@index([fileId])
  @@index([userId])
  @@index([action])
  @@index([occurredAt])
  @@map("file_history")
}

model FileTypePattern {
  id        String   @id @default(cuid())
  fileType  FileType
  pattern   String
  priority  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([fileType])
  @@index([priority])
  @@map("file_type_patterns")
}

// Nouvelle table pour gérer les périodes comptables
model ComptablePeriod {
  id            String        @id @default(cuid())
  clientId      String
  periodStart   DateTime
  periodEnd     DateTime
  year          Int
  batchId       String        @unique
  status        ProcessingStatus @default(PENDING)

  // Tracking
  createdAt     DateTime      @default(now())
  processedAt   DateTime?

  // Relations
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  files         File[]        @relation("PeriodFiles")

  @@unique([clientId, periodStart, periodEnd])
  @@index([clientId])
  @@index([status])
  @@map("comptable_periods")
}

enum PackType {
  ENTREPRISE
  SIMPLE
}

enum UserRole {
  ADMIN_ROOT
  ADMIN
  USER
}

enum CompanyType {
  TECHNOLOGIE
  FINANCE
  SANTE
  EDUCATION
  COMMERCE
  INDUSTRIE
  AGRICULTURE
  IMMOBILIER
  TRANSPORT
  ENERGIE
  TELECOMMUNICATION
  TOURISME
}

enum FileType {
  GRAND_LIVRE_COMPTES
  GRAND_LIVRE_TIERS
  PLAN_COMPTES
  PLAN_TIERS
  CODE_JOURNAL
}

// NOUVEAU ENUM : Catégorisation des fichiers
enum FileCategory {
  NORMAL      // Fichiers vrac (PDF, images, etc.)
  COMPTABLE   // Fichiers pour ETL
}

// NOUVEAU ENUM : Etats de traitement des fichiers comptables et batchs
enum ProcessingStatus {
  PENDING     // En attente de traitement
  VALIDATING  // Validation en cours
  PROCESSING  // ETL en cours
  COMPLETED   // Traité avec succès
  FAILED      // Échec de traitement
}

enum FileStatus {
  EN_COURS
  SUCCES
  ERROR
}

enum SocialNetworkType {
  FACEBOOK
  LINKEDIN
  TWITTER
}
